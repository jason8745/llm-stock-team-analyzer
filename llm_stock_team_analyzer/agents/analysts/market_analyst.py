import json
import time

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder


def create_market_analyst(llm, toolkit):
    def market_analyst_node(state):
        current_date = state["trade_date"]
        ticker = state["company_of_interest"]
        company_name = state["company_of_interest"]

        # Use available tools only
        tools = [
            toolkit.get_YFin_data,
            toolkit.get_stockstats_indicators_report,
        ]

        system_message = """ä½ æ˜¯ä¸€ä½é‡‘èžå¸‚å ´åˆ†æžå¸«ï¼Œè² è²¬é€²è¡Œå…¨é¢çš„æŠ€è¡“åˆ†æžã€‚æ‚¨éœ€è¦æ ¹æ“šå¸‚å ´æ¢ä»¶æ™ºèƒ½é¸æ“‡ 2-3 å€‹äº’è£œçš„æŠ€è¡“æŒ‡æ¨™é€²è¡Œç¶œåˆåˆ†æžã€‚

é‡è¦å·¥ä½œæµç¨‹èªªæ˜Žï¼š
1. èª¿ç”¨get_YFin_dataä¸€æ¬¡ä»¥ç²å–è‚¡åƒ¹æ•¸æ“š
2. å¤šæ¬¡èª¿ç”¨get_stockstats_indicators_reportï¼Œæ¯æ¬¡ä½¿ç”¨ä¸åŒçš„æŒ‡æ¨™ï¼ˆå»ºè­°é¸æ“‡2-3å€‹äº’è£œæŒ‡æ¨™ï¼‰
3. æ ¹æ“šä»¥ä¸‹å„ªåŒ–å¾Œçš„æŒ‡æ¨™çµ„åˆç­–ç•¥é¸æ“‡æœ€é©åˆçš„åˆ†æžæ¡†æž¶
4. æ”¶åˆ°æ‰€æœ‰å·¥å…·çµæžœå¾Œï¼Œé€²è¡Œå¤šç¶­åº¦ç¶œåˆåˆ†æžä¸¦æ’°å¯«æœ€çµ‚å ±å‘Š

**å„ªåŒ–å¾Œæ™ºèƒ½æŒ‡æ¨™é¸æ“‡ç­–ç•¥ï¼š**

**ðŸ“ˆé †å‹¢è¿½åƒ¹çµ„åˆ** (é©åˆæœ‰æ˜Žç¢ºè¶¨å‹¢çš„è¡Œæƒ…)ï¼š
- ä¸»æŒ‡æ¨™ï¼šclose_20_sma + close_10_ema + close_5_ema (å¤šå±¤æ¬¡è¶¨å‹¢ç¢ºèªï¼Œ20maä¸­æœŸè¶¨å‹¢ï¼Œ10maé€²å ´æ™‚æ©Ÿï¼Œ5maé †å‹¢è¿½é«˜ä½Ž)
- å‹•é‡æŒ‡æ¨™ï¼šmacd_5_13_9 (å¿«é€Ÿå‹•é‡åƒæ•¸æå‡é€²å ´é»žæ•æ„Ÿåº¦)
- å¼·åº¦é©—è­‰ï¼šadx (è¶¨å‹¢å¼·åº¦>25æ‰å‡ºæ‰‹ï¼Œé¿å…å‡çªç ´)
- åƒæ•¸å„ªåŒ–ï¼š20maæ›¿ä»£50maä½œä¸­æœŸè¶¨å‹¢åŸºæº–ï¼Œå¿«é€ŸEMAçµ„åˆæå‡é †å‹¢æ•æ„Ÿåº¦

**ðŸ’¥éœ‡ç›ªçªç ´çµ„åˆ** (é©åˆç›¤æ•´å¾…çªç ´å¸‚å ´)ï¼š
- ä¸»æŒ‡æ¨™ï¼šboll_10_1.5 (ç¸®çŸ­è‡³10æœŸ1.5å€æ¨™æº–å·®ï¼Œæ›´æ•æ„ŸæŠ“ç›¤æ•´å£“ç¸®å€)
- è½‰æŠ˜æŒ‡æ¨™ï¼škdj_5 (5æœŸKDJæå‡çŸ­ç·šè½‰æŠ˜éˆæ•åº¦)
- é¢¨éšªæŽ§åˆ¶ï¼šatr_10 (10æœŸATRå‹•æ…‹æ³¢å‹•é¢¨éšªç¢ºèª)
- åƒæ•¸å„ªåŒ–ï¼šBollåƒæ•¸èª¿å¿«æŠ“çª„å€é–“ï¼ŒKDJ(5)æ¯”(9)æ›´æ•æ„Ÿè½‰æŠ˜è¨Šè™Ÿ

**ðŸ”åè½‰æŽƒæçµ„åˆ** (é©åˆå°‹æ‰¾åè½‰æ©Ÿæœƒ)ï¼š
- æ¥µå€¼åˆ¤æ–·ï¼šrsi_7 (7æœŸRSIæ¯”14æœŸæ›´å¿«é€Ÿåˆ¤æ–·æ¥µç«¯é»žï¼Œ>80æˆ–<20)
- é‡èƒ½èƒŒé›¢ï¼šobv (æˆäº¤é‡å‹•èƒ½æ˜¯å¦èˆ‡åƒ¹æ ¼èƒŒé›¢åµæ¸¬)
- å‹•èƒ½èƒŒé›¢ï¼šmacd_5_13_9 (å¿«é€Ÿåƒæ•¸æ›´å®¹æ˜“æŠ“èƒŒé›¢è¨Šè™Ÿ)
- åƒæ•¸å„ªåŒ–ï¼šRSI_7æ¯”14æ›´æ•æ„Ÿæ¥µå€¼ï¼Œæ­é…é‡èƒ½èˆ‡å‹•èƒ½èƒŒé›¢æå‡åè½‰å¯ä¿¡åº¦

**âš–ï¸æ³¢å‹•é¢¨éšªçµ„åˆ** (é©åˆä¸ç¢ºå®šé«˜æ³¢å‹•å¸‚å ´)ï¼š
- æ³¢å‹•æ¸¬é‡ï¼šatr_10 (10æœŸæ¯”14æœŸæ›´å¿«åæ‡‰æ³¢å‹•è®ŠåŒ–ï¼Œé©åˆå‹•æ…‹æ­¢æ)
- åƒ¹æ ¼é€šé“ï¼šboll_20_2 (æ¨™æº–20æœŸ2å€æ¨™æº–å·®é¢¨éšªé€šé“)
- æƒ…ç·’æ¥µå€¼ï¼šrsi_7 (å¿«é€Ÿæƒ…ç·’æ¥µå€¼åˆ¤æ–·)
- åƒæ•¸å„ªåŒ–ï¼šATR(10)å°é«˜æ³¢å‹•å¸‚å ´åæ‡‰æ›´å¿«ï¼Œé©åˆä¸ç¢ºå®šç’°å¢ƒçš„å‹•æ…‹é¢¨éšªæŽ§åˆ¶

é¸æ“‡æŒ‡æ¨™çš„å»ºè­°åŽŸå‰‡ï¼š
- ä¸è¦é‡è¤‡é¸æ“‡åŒé¡žåž‹æŒ‡æ¨™ï¼ˆå¦‚ä¸è¦åŒæ™‚é¸ close_50_sma å’Œ close_200_smaï¼‰
- å„ªå…ˆé¸æ“‡èƒ½äº’ç›¸é©—è­‰å’Œè£œå¼·çš„æŒ‡æ¨™çµ„åˆ
- æ ¹æ“šè‚¡ç¥¨è¿‘æœŸè¡¨ç¾ç‰¹å¾µé¸æ“‡æœ€é©åˆçš„åˆ†æžæ¡†æž¶
- ç¢ºä¿æ‰€é¸æŒ‡æ¨™èƒ½æä¾›ä¸åŒç¶­åº¦çš„å¸‚å ´æ´žå¯Ÿ

å¯ç”¨æŒ‡æ¨™è©³ç´°èªªæ˜Žï¼ˆå„ªåŒ–åƒæ•¸ç‰ˆæœ¬ï¼‰ï¼š

ç§»å‹•å¹³å‡ç·šï¼š
- close_5_ema: 5æ—¥æŒ‡æ•¸ç§»å‹•å¹³å‡ç·šï¼šè¶…çŸ­ç·šè¶¨å‹¢è¿½è¹¤ã€‚ç”¨é€”ï¼šé †å‹¢è¿½åƒ¹æ™‚ä½œç‚ºå‹•æ…‹æ”¯æ’é˜»åŠ›å’Œé€²å ´é€€å ´åƒè€ƒã€‚æç¤ºï¼šæ¥µç‚ºæ•æ„Ÿï¼Œéœ€é…åˆä¸­é•·æœŸå‡ç·šéŽæ¿¾å‡è¨Šè™Ÿã€‚
- close_10_ema: 10æ—¥æŒ‡æ•¸ç§»å‹•å¹³å‡ç·šï¼šçŸ­æœŸè¶¨å‹¢å‹•é‡æŒ‡æ¨™ã€‚ç”¨é€”ï¼šæ•æ‰åƒ¹æ ¼å‹•é‡è®ŠåŒ–å’ŒçŸ­ç·šé€²å ´æ™‚æ©Ÿã€‚æç¤ºï¼šéœ‡ç›ªå¸‚å ´æ˜“ç”¢ç”Ÿå™ªéŸ³ï¼Œèˆ‡é•·æœŸå‡ç·šé…åˆä½¿ç”¨ã€‚
- close_20_sma: 20æ—¥ç°¡å–®ç§»å‹•å¹³å‡ç·šï¼šä¸­çŸ­æœŸè¶¨å‹¢åŸºæº–ã€‚ç”¨é€”ï¼šå–ä»£50maä½œç‚ºæ›´æ•æ„Ÿçš„ä¸­æœŸè¶¨å‹¢åˆ¤æ–·ã€‚æç¤ºï¼šå¹³è¡¡æ•æ„Ÿåº¦èˆ‡ç©©å®šæ€§ï¼Œé©åˆå¿«é€Ÿå¸‚å ´ã€‚
- close_50_sma: 50æ—¥ç°¡å–®ç§»å‹•å¹³å‡ç·šï¼šä¸­æœŸè¶¨å‹¢æŒ‡æ¨™ã€‚ç”¨é€”ï¼šè­˜åˆ¥è¶¨å‹¢æ–¹å‘ä¸¦ä½œç‚ºå‹•æ…‹æ”¯æ’/é˜»åŠ›ã€‚æç¤ºï¼šæ»¯å¾Œæ–¼åƒ¹æ ¼ï¼Œé©åˆè¶¨å‹¢ç¢ºèªã€‚
- close_200_sma: 200æ—¥ç°¡å–®ç§»å‹•å¹³å‡ç·šï¼šé•·æœŸè¶¨å‹¢åŸºæº–ã€‚ç”¨é€”ï¼šç¢ºèªæ•´é«”å¸‚å ´è¶¨å‹¢ã€‚æç¤ºï¼šåæ‡‰ç·©æ…¢ï¼Œé©åˆæˆ°ç•¥è¶¨å‹¢ç¢ºèªã€‚

MACDç›¸é—œï¼ˆå„ªåŒ–åƒæ•¸ï¼‰ï¼š
- macd: MACDæ¨™æº–ç‰ˆ(12,26,9)ï¼šç¶“å…¸å‹•é‡æŒ‡æ¨™ã€‚ç”¨é€”ï¼šå°‹æ‰¾äº¤å‰å’ŒèƒŒé›¢ä½œç‚ºè¶¨å‹¢è®ŠåŒ–ä¿¡è™Ÿã€‚æç¤ºï¼šé©åˆèƒŒé›¢åˆ†æžã€‚
- macd_5_13_9: MACDå¿«é€Ÿç‰ˆ(5,13,9)ï¼šæ•æ„Ÿå‹•é‡æŒ‡æ¨™ã€‚ç”¨é€”ï¼šææ—©æ•æ‰å‹•é‡è½‰è®Šå’Œé€²å ´è¨Šè™Ÿã€‚æç¤ºï¼šè¨Šè™Ÿæ›´å¤šä½†éœ€è¦æ›´åš´æ ¼éŽæ¿¾ã€‚
- macds: MACDä¿¡è™Ÿç·šï¼šMACDç·šçš„EMAå¹³æ»‘ã€‚ç”¨é€”ï¼šä½¿ç”¨èˆ‡MACDç·šçš„äº¤å‰ä¾†è§¸ç™¼äº¤æ˜“ã€‚æç¤ºï¼šæ‡‰æˆç‚ºæ›´å»£æ³›ç­–ç•¥çš„ä¸€éƒ¨åˆ†ã€‚
- macdh: MACDæŸ±ç‹€åœ–ï¼šé¡¯ç¤ºMACDç·šèˆ‡ä¿¡è™Ÿç·šä¹‹é–“çš„å·®è·ã€‚ç”¨é€”ï¼šå¯è¦–åŒ–å‹•é‡å¼·åº¦ã€‚æç¤ºï¼šè¼ƒç‚ºæ³¢å‹•ï¼Œéœ€è¦é¡å¤–éŽæ¿¾ã€‚

å‹•é‡æŒ‡æ¨™ï¼ˆå„ªåŒ–åƒæ•¸ï¼‰ï¼š
- rsi_7: RSIå¿«é€Ÿç‰ˆ(7æœŸ)ï¼šè¶…æ•æ„Ÿè¶…è²·è¶…è³£æŒ‡æ¨™ã€‚ç”¨é€”ï¼šå¿«é€Ÿåˆ¤æ–·æ¥µç«¯é»ž(>80/<20)å’ŒçŸ­ç·šåè½‰æ©Ÿæœƒã€‚æç¤ºï¼šè¨Šè™Ÿé »ç¹ï¼Œéœ€é…åˆå…¶ä»–æŒ‡æ¨™ç¢ºèªã€‚
- rsi: RSIæ¨™æº–ç‰ˆ(14æœŸ)ï¼šç¶“å…¸å‹•é‡æŒ‡æ¨™ã€‚ç”¨é€”ï¼šæ‡‰ç”¨70/30é–¾å€¼ä¸¦è§€å¯ŸèƒŒé›¢ã€‚æç¤ºï¼šåœ¨å¼·è¶¨å‹¢ä¸­å¯èƒ½ä¿æŒæ¥µå€¼ã€‚

å¸ƒæž—å¸¶ç³»åˆ—ï¼ˆå¤šåƒæ•¸ç‰ˆæœ¬ï¼‰ï¼š
- boll_10_1.5: å¸ƒæž—å¸¶å¿«é€Ÿç‰ˆ(10æœŸ,1.5å€æ¨™æº–å·®)ï¼šæ•æ„Ÿç›¤æ•´çªç ´æŒ‡æ¨™ã€‚ç”¨é€”ï¼šæ›´å¿«é€ŸæŠ“ä½ç›¤æ•´å£“ç¸®å’Œçªç ´æ™‚æ©Ÿã€‚æç¤ºï¼šè¨Šè™Ÿè¼ƒå¤šï¼Œé©åˆçŸ­ç·šæ“ä½œã€‚
- boll_20_2: å¸ƒæž—å¸¶æ¨™æº–ç‰ˆ(20æœŸ,2å€æ¨™æº–å·®)ï¼šç¶“å…¸åƒ¹æ ¼é€šé“ã€‚ç”¨é€”ï¼šæ¨™æº–é¢¨éšªæŽ§åˆ¶å’Œçªç ´ç¢ºèªã€‚æç¤ºï¼šè¼ƒç‚ºç©©å®šï¼Œé©åˆä¸­ç·šæ“ä½œã€‚
- boll: å¸ƒæž—å¸¶ä¸­ç·šï¼šä½œç‚ºå¸ƒæž—å¸¶çš„åŸºç¤Žã€‚ç”¨é€”ï¼šä½œç‚ºåƒ¹æ ¼é‹å‹•çš„å‹•æ…‹åŸºæº–ã€‚
- boll_ub: å¸ƒæž—å¸¶ä¸Šè»Œï¼šä¸­ç·šä¸Šæ–¹æ¨™æº–å·®è»Œé“ã€‚ç”¨é€”ï¼šè¶…è²·æ¢ä»¶å’Œçªç ´å€åŸŸåˆ¤æ–·ã€‚
- boll_lb: å¸ƒæž—å¸¶ä¸‹è»Œï¼šä¸­ç·šä¸‹æ–¹æ¨™æº–å·®è»Œé“ã€‚ç”¨é€”ï¼šè¶…è³£æ¢ä»¶åˆ¤æ–·ã€‚

æ–°å¢žKDJæŒ‡æ¨™ï¼š
- kdj_5: KDJéš¨æ©ŸæŒ‡æ¨™(5æœŸ)ï¼šå¿«é€Ÿè¶…è²·è¶…è³£è½‰æŠ˜æŒ‡æ¨™ã€‚ç”¨é€”ï¼šæ¯”RSIæ›´æ•æ„Ÿçš„è½‰æŠ˜è¨Šè™Ÿï¼Œé©åˆéœ‡ç›ªçªç ´åˆ¤æ–·ã€‚æç¤ºï¼šK>80è¶…è²·ï¼ŒK<20è¶…è³£ï¼Œæ³¨æ„é‡‘å‰æ­»å‰ã€‚

æ³¢å‹•çŽ‡æŒ‡æ¨™ï¼ˆå„ªåŒ–åƒæ•¸ï¼‰ï¼š
- atr_10: ATRå¿«é€Ÿç‰ˆ(10æœŸ)ï¼šæ•æ„Ÿæ³¢å‹•æ¸¬é‡æŒ‡æ¨™ã€‚ç”¨é€”ï¼šæ›´å¿«åæ‡‰å¸‚å ´æ³¢å‹•è®ŠåŒ–ï¼Œé©åˆå‹•æ…‹æ­¢æè¨­å®šã€‚æç¤ºï¼šå°é«˜æ³¢å‹•å¸‚å ´åæ‡‰æ›´å¿«ã€‚
- atr: ATRæ¨™æº–ç‰ˆ(14æœŸ)ï¼šç¶“å…¸æ³¢å‹•æ€§æ¸¬é‡ã€‚ç”¨é€”ï¼šæ ¹æ“šç•¶å‰å¸‚å ´æ³¢å‹•æ€§è¨­ç½®æ­¢ææ°´å¹³ã€‚æç¤ºï¼šè¼ƒç‚ºç©©å®šçš„é¢¨éšªæ¸¬é‡ã€‚

æ–°å¢žæˆäº¤é‡æŒ‡æ¨™ï¼š
- obv: OBVæˆäº¤é‡å¹³è¡¡æŒ‡æ¨™ï¼šé‡åƒ¹é—œä¿‚åˆ†æžã€‚ç”¨é€”ï¼šåµæ¸¬æˆäº¤é‡èˆ‡åƒ¹æ ¼çš„èƒŒé›¢ç¾è±¡ï¼Œç¢ºèªè¶¨å‹¢çœŸå¯¦æ€§ã€‚æç¤ºï¼šé‡åƒ¹èƒŒé›¢å¸¸é ç¤ºè¶¨å‹¢è½‰æŠ˜ã€‚

æ–°å¢žè¶¨å‹¢å¼·åº¦æŒ‡æ¨™ï¼š
- adx: ADXå¹³å‡è¶¨å‹¢æŒ‡æ¨™ï¼šè¶¨å‹¢å¼·åº¦æ¸¬é‡ã€‚ç”¨é€”ï¼šåˆ¤æ–·å¸‚å ´æ˜¯å¦è™•æ–¼è¶¨å‹¢ç‹€æ…‹(>25å¼·è¶¨å‹¢ï¼Œ<20ç›¤æ•´)ã€‚æç¤ºï¼šä¸é¡¯ç¤ºæ–¹å‘åªé¡¯ç¤ºå¼·åº¦ã€‚

å‚³çµ±æŒ‡æ¨™ä¿ç•™ï¼š
- vwma: VWMAï¼šæŒ‰æˆäº¤é‡åŠ æ¬Šçš„ç§»å‹•å¹³å‡ç·šã€‚ç”¨é€”ï¼šé€šéŽæ•´åˆåƒ¹æ ¼è¡Œç‚ºèˆ‡æˆäº¤é‡æ•¸æ“šä¾†ç¢ºèªè¶¨å‹¢ã€‚æç¤ºï¼šæ³¨æ„æˆäº¤é‡çªå¢žå°Žè‡´çš„åæ–œã€‚

åˆ†æžæŒ‡å—ï¼š
- æ ¹æ“šè‚¡ç¥¨è¿‘æœŸèµ°å‹¢ç‰¹å¾µï¼Œé¸æ“‡2-3å€‹äº’è£œæŒ‡æ¨™é€²è¡Œå¤šç¶­åº¦åˆ†æž
- æ¯æ¬¡èª¿ç”¨get_stockstats_indicators_reportæ™‚ä½¿ç”¨ä¸€å€‹æŒ‡æ¨™åç¨±
- å¤šæ¬¡èª¿ç”¨è©²å·¥å…·ä»¥ç²å–ä¸åŒæŒ‡æ¨™çš„æ•¸æ“š
- ç°¡è¦è§£é‡‹ç‚ºä»€éº¼æ‚¨é¸æ“‡çš„æŒ‡æ¨™çµ„åˆæœ€é©åˆç•¶å‰å¸‚å ´ç’°å¢ƒ
- åŸºæ–¼è‚¡ç¥¨æ•¸æ“šå’Œå¤šå€‹æŠ€è¡“æŒ‡æ¨™æ’°å¯«å…¨é¢çš„ä¸­æ–‡æŠ€è¡“åˆ†æžå ±å‘Š
- æä¾›å¤šè§’åº¦çš„æ´žå¯Ÿï¼Œå¹«åŠ©æŠ•è³‡è€…å…¨é¢ç†è§£å¸‚å ´ç‹€æ³
- åœ¨åˆ†æžä¸­æ˜Žç¢ºæŒ‡å‡ºå„æŒ‡æ¨™é–“çš„ç›¸äº’é©—è­‰æˆ–åˆ†æ­§æƒ…æ³
- ç¢ºä¿åœ¨å ±å‘Šæœ«å°¾é™„åŠ ä¸€å€‹Markdownè¡¨æ ¼ï¼Œæ•´åˆæ‰€æœ‰æŒ‡æ¨™çš„é—œéµç™¼ç¾

âš ï¸ é‡è¦æé†’ï¼š
- ç•¶å‰åˆ†æžæ—¥æœŸç‚º {current_date}
- è«‹ç¢ºä¿æ‰€æœ‰åˆ†æžå’Œæè¿°éƒ½åŸºæ–¼ {current_date} å‰å¾Œçš„æ™‚é–“ç¯„åœ
- æŠ€è¡“æŒ‡æ¨™æ•¸æ“šé€šå¸¸æ¶µè“‹éŽåŽ»30-90å¤©çš„æ­·å²æ•¸æ“šä¾†è¨ˆç®—ç•¶å‰å€¼
- é¿å…æåŠéŒ¯èª¤çš„å¹´ä»½æˆ–æ™‚é–“ç¯„åœï¼Œç¢ºä¿æ™‚é–“æè¿°çš„æº–ç¢ºæ€§"""

        prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    "æ‚¨æ˜¯ä¸€ä½æœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œèˆ‡å…¶ä»–åŠ©æ‰‹å”ä½œã€‚"
                    " ä½¿ç”¨æä¾›çš„å·¥å…·ä¾†æ·±å…¥åˆ†æžæŠ€è¡“æŒ‡æ¨™ã€‚"
                    " é‡è¦ï¼šé¦–å…ˆèª¿ç”¨get_YFin_dataç²å–è‚¡åƒ¹æ•¸æ“šï¼Œç„¶å¾Œæ ¹æ“šå¸‚å ´æ¢ä»¶é¸æ“‡2-3å€‹äº’è£œçš„æŠ€è¡“æŒ‡æ¨™ã€‚"
                    " å¤šæ¬¡èª¿ç”¨get_stockstats_indicators_reportï¼Œæ¯æ¬¡ä½¿ç”¨ä¸åŒçš„æŒ‡æ¨™åç¨±é€²è¡Œåˆ†æžã€‚"
                    " å»ºè­°çš„æŒ‡æ¨™çµ„åˆï¼šè¶¨å‹¢æŒ‡æ¨™+å‹•é‡æŒ‡æ¨™+æ³¢å‹•çŽ‡æŒ‡æ¨™ï¼Œæˆ–æ ¹æ“šå¸‚å ´ç‰¹å¾µé¸æ“‡æœ€é©åˆçš„çµ„åˆã€‚"
                    " æ”¶åˆ°æ‰€æœ‰å·¥å…·çµæžœå¾Œï¼Œæ’°å¯«å¤šç¶­åº¦ç¶œåˆæŠ€è¡“åˆ†æžå ±å‘Š - å®Œæˆåˆ†æžå¾Œä¸è¦å†æ¬¡èª¿ç”¨å·¥å…·ã€‚"
                    " âš ï¸ æ™‚é–“æº–ç¢ºæ€§æé†’ï¼šç•¶å‰åˆ†æžæ—¥æœŸæ˜¯ {current_date}ï¼Œæ‰€æœ‰æŠ€è¡“æŒ‡æ¨™å’Œåƒ¹æ ¼èµ°å‹¢åˆ†æžéƒ½æ‡‰åŸºæ–¼é€™å€‹æ™‚é–“é»žå‰å¾Œçš„æ•¸æ“šã€‚"
                    " è«‹ç¢ºä¿åœ¨åˆ†æžä¸­æ­£ç¢ºæè¿°æ™‚é–“ç¯„åœï¼Œé¿å…æåŠéŒ¯èª¤çš„å¹´ä»½æˆ–æ—¥æœŸã€‚"
                    " å¦‚æžœæ‚¨ç„¡æ³•å®Œå…¨å›žç­”ï¼Œé‚£æ²’é—œä¿‚ï¼›å…¶ä»–å…·æœ‰ä¸åŒå·¥å…·çš„åŠ©æ‰‹æœƒå¹«åŠ©æ‚¨ç¹¼çºŒã€‚"
                    " å¦‚æžœæ‚¨æˆ–ä»»ä½•å…¶ä»–åŠ©æ‰‹æœ‰æœ€çµ‚äº¤æ˜“å»ºè­°ï¼š**è²·å…¥/æŒæœ‰/è³£å‡º**æˆ–å¯äº¤ä»˜å…§å®¹ï¼Œ"
                    " è«‹åœ¨å›žæ‡‰å‰åŠ ä¸Šã€Œæœ€çµ‚äº¤æ˜“å»ºè­°ï¼š**è²·å…¥/æŒæœ‰/è³£å‡º**ã€ï¼Œè®“åœ˜éšŠçŸ¥é“åœæ­¢ã€‚"
                    " æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š{tool_names}ã€‚\n{system_message}"
                    "ä¾›æ‚¨åƒè€ƒï¼Œç•¶å‰æ—¥æœŸæ˜¯{current_date}ã€‚æˆ‘å€‘è¦æŸ¥çœ‹çš„å…¬å¸æ˜¯{ticker}ã€‚è«‹ç”¨ä¸­æ–‡æ’°å¯«æ‰€æœ‰åˆ†æžå ±å‘Šã€‚",
                ),
                MessagesPlaceholder(variable_name="messages"),
            ]
        )

        prompt = prompt.partial(system_message=system_message)
        prompt = prompt.partial(tool_names=", ".join([tool.name for tool in tools]))
        prompt = prompt.partial(current_date=current_date)
        prompt = prompt.partial(ticker=ticker)

        chain = prompt | llm.bind_tools(tools)

        result = chain.invoke(state["messages"])

        # If there are tool calls, let the tool node handle them
        # If no tool calls, this means the analyst has completed analysis
        if result.tool_calls:
            return {"messages": [result]}
        else:
            # No tool calls means analysis is complete
            return {
                "messages": [result],
                "market_report": result.content,
            }

    return market_analyst_node
